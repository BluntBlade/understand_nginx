# 解码Nginx：内存池  

梁涛（@无锋之刃）  
2012-11-17 ~ 2012-11-18  

## 背景  

对于HTTP服务器而言，“每秒处理请求数”是非常关键的性能指标。处理路径上每一步动作的时间开销，都将对该指标造成影响。特别地，内存分配/释放作为最基础的动作，对总处理时间施加的影响更为巨大————想想那些伴随复杂数据结构或细碎逻辑产生的内存分配/释放动作，很可能在单次处理中执行数十次，假设每次动作都调用malloc()/free()函数，时间开销将颇为可观、无法接受。由此，Nginx针对HTTP应用的业务特点，重新设计出一套内存管理机制，以内存池的形式提供给上层结构使用，从而有效地优化性能。  

根据分配/释放频繁程度，HTTP应用的内存使用特征可以划分为两类：  

1. 进程初始化时分配、终止时释放的大块内存，供应给配置文件等全程不会变化的数据结构使用;  
2. 处理单次请求时反复分配/释放的小块内存，供应给字符串处理等小型结构体和临时数据使用。  

对于前者，使用malloc()/free()带来的时间开销并无大碍；对于后者，一旦使用完后即刻调用free()释放内存，则会产生许多不必要的时间开销。更理想的作法是将零碎分配得来的内存收集起来，在某个时间点集中释放掉，亦即“多次分配，一次释放”。通过设计得当的数据结构和接口，可以在确保“谁分配，谁释放”的内存使用原则下，提供更好的性能。  

## 内存管理模型  

Nginx将内存管理模型组织为两层结构：  

1. 第一层结构采用“向系统请求大块内存（多次）——按需分配内存（多次）——集中释放内存（单次）”的设计思路，每次分配不超过某个固定长度上限的小块内存;  
2. 第二层结构采用简单的“向系统请求大块内存（多次+转发）”的设计思路，亦即转发分配请求给malloc()，以分配第一层不负责管理的更大块的内存。  

除此以外，还包装了malloc()/free()以及更为底层的memalign()/posix_memalign()，用以分配更加大块的内存。  

### 第一层结构  

    ngx_create_pool()              ngx_palloc()/ngx_pnalloc()        ngx_palloc()/ngx_pnalloc()        ...
     |                              |                                 |
     |                              \- ngx_palloc_block()             \- ngx_palloc_block()
     |                                  |                                 |
     \- ngx_memalign() ------\          \- ngx_memalign() ------\         \- ngx_memalign() ----\
                             |                                  |                               |
                             |                                  |                               |
          ngx_pool_t         V                 ngx_pool_data_t  V              ngx_pool_data_t  V
    /--> +-------------------+         /----> +-----------------+         /-> +-----------------+  /-> ...
    |    | ngx_pool_data_t d |         |      | last            | --\     |   | last            |  | 
    |    |  +----------------+         |      +-----------------+   |     |   +-----------------+  | 
    |    |  | last           | --\     |      | end             | --+--\  |   | end             |  | 
    |    |  +----------------+   |     |      +-----------------+   |  |  |   +-----------------+  |
    |    |  | end            | --+--\  |      | next            | --+--+--/   | next            |--/
    |    |  +----------------+   |  |  |      +-----------------+   |  |      +-----------------+
    |    |  | next           | --+--+--/      | failed          |   |  |      | failed          |
    |    |  +----------------+   |  |         +-----------------+   |  |      +-----------------+
    |    |  | failed         |   |  |         | allocated       |   |  |      | allocated       |
    |    +--+----------------+   |  |         | area            |   |  |      | area            |
    |    | max               |   |  |         /-----------------/ <-/  |      /-----------------/
    |    +-------------------+   |  |         / unallocated     /      |      / unallocated     /
    \--- | current           |   |  |         | area            |      |      | area            |
         +-------------------+   |  |         |                 |      |      |                 |
         | chain             | --+--+-----\   |                 |      |      |                 |
         +-------------------+   |  |     |   |                 |      |      |                 |
         | large             | --+--+--\  |   +-----------------+ <----/      +-----------------+
         +-------------------+   |  |  |  |      
    /--- | cleanup           |   |  |  |  |      
    |    +-------------------+   |  |  |  |      
    |    | log               |   |  |  |  |                              
    |    +-------------------+   |  |  |  \-> ???                     
    |    | allocated         |   |  |  |                           
    |    | area              |   |  |  |                           
    |    /-------------------/ <-/  |  \----> 第二层内存管理结构
    |    / unallocated       /      |         (ngx_pool_large_t)
    |    | area              |      |  
    |    |                   |      |  
    |    |                   |      |  
    |    |                   |      |  
    |    +-------------------+ <----/  
    |                            
    |                            
    |     ngx_pool_cleanup_t     
    \--> +-------------------+   
         |  handler          |   
         +-------------------+   
         |  data             | 
         +-------------------+
    /--- |  next             |
    |    +-------------------+
    |
    |     ngx_pool_cleanup_t
    \--> +-------------------+
         |  handler          |
         +-------------------+
         |  data             |
         +-------------------+
         |  next             |
         +-------------------+

### 第二层结构  

         +-------------------+       /-----> +-------------------+       /-----> ...
         |  alloc            |       |       |  alloc            |       |      
         +-------------------+       |       +-------------------+       |      
         |  next             | ------/       |  next             | ------/      
         +-------------------+               +-------------------+              
